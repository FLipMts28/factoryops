# üîß Corre√ß√£o: Eventos de Paragem Filtrados por Linha

## üêõ Problema Identificado

Os **Eventos de Paragem** mostravam sempre as mesmas 3 m√°quinas (hardcoded), independentemente do filtro de linha de produ√ß√£o selecionado.

**Exemplo do problema:**
- Filtro: "Linha de Chassis"
- Eventos mostrados: "Rob√¥ de Soldadura 12", "Prensa Hidr√°ulica 3", "CNC Fresadora 8"
- ‚ùå Essas m√°quinas podem n√£o estar na linha selecionada!

---

## ‚úÖ Solu√ß√£o Implementada

### **Antes: Eventos Hardcoded**

```typescript
const downtimeEvents = [
  {
    id: '1',
    machineName: 'Rob√¥ de Soldadura 12',
    startTime: new Date(Date.now() - 2 * 60 * 60 * 1000),
    duration: 45,
    reason: 'Falha no sensor de proximidade',
    status: 'IN_PROGRESS',
  },
  {
    id: '2',
    machineName: 'Prensa Hidr√°ulica 3',
    startTime: new Date(Date.now() - 5 * 60 * 60 * 1000),
    duration: 120,
    reason: 'Manuten√ß√£o preventiva',
    status: 'RESOLVED',
  },
  {
    id: '3',
    machineName: 'CNC Fresadora 8',
    startTime: new Date(Date.now() - 24 * 60 * 60 * 1000),
    duration: 180,
    reason: 'Substitui√ß√£o de componente',
    status: 'RESOLVED',
  },
];
```

‚ùå **Problemas:**
- Sempre as mesmas 3 m√°quinas
- N√£o respeita filtro de linha de produ√ß√£o
- Dados fict√≠cios que n√£o mudam

---

### **Depois: Eventos Din√¢micos Filtrados**

```typescript
// Gerar eventos de paragem baseados nas m√°quinas filtradas
const generateDowntimeEvents = () => {
  const events = [];
  
  // Filtrar apenas m√°quinas com problemas NA LINHA SELECIONADA
  const problemMachines = filteredMachines.filter(
    m => m.status === MachineStatus.FAILURE || m.status === MachineStatus.MAINTENANCE
  );

  // Pegar at√© 5 eventos de m√°quinas com problemas
  const selectedMachines = problemMachines.slice(0, 5);
  
  selectedMachines.forEach((machine, index) => {
    const hoursAgo = (index + 1) * 2; // 2h, 4h, 6h, etc
    const duration = 45 + Math.random() * 135; // 45-180 minutos
    
    const reasons = {
      [MachineStatus.FAILURE]: [
        'Falha no sensor de proximidade',
        'Erro de comunica√ß√£o PLC',
        'Sobrecarga do motor principal',
        'Falha no sistema hidr√°ulico',
        'Problema el√©trico detectado',
      ],
      [MachineStatus.MAINTENANCE]: [
        'Manuten√ß√£o preventiva programada',
        'Substitui√ß√£o de componente',
        'Lubrifica√ß√£o e ajustes',
        'Calibra√ß√£o de sensores',
        'Atualiza√ß√£o de software',
      ],
    };

    const statusReasons = reasons[machine.status] || reasons[MachineStatus.FAILURE];
    const randomReason = statusReasons[Math.floor(Math.random() * statusReasons.length)];

    events.push({
      id: machine.id,
      machineName: machine.name,
      startTime: new Date(Date.now() - hoursAgo * 60 * 60 * 1000),
      duration: Math.round(duration),
      reason: randomReason,
      status: machine.status === MachineStatus.FAILURE ? 'IN_PROGRESS' : 'RESOLVED',
    });
  });

  return events;
};

const downtimeEvents = generateDowntimeEvents();
```

‚úÖ **Melhorias:**
- Eventos gerados dinamicamente
- Baseados nas m√°quinas da linha selecionada
- Apenas m√°quinas com status FAILURE ou MAINTENANCE
- At√© 5 eventos mostrados
- Raz√µes realistas baseadas no status

---

## üéØ Como Funciona Agora

### Exemplo 1: Todas as Linhas
```
Filtro: "Todas as Linhas"
‚Üì
filteredMachines = todas as 20 m√°quinas
‚Üì
problemMachines = 8 m√°quinas (FAILURE ou MAINTENANCE)
‚Üì
Eventos mostrados: 5 primeiras m√°quinas com problemas
```

### Exemplo 2: Linha de Chassis
```
Filtro: "Linha de Chassis"
‚Üì
filteredMachines = 6 m√°quinas da linha de chassis
‚Üì
problemMachines = 2 m√°quinas (FAILURE ou MAINTENANCE)
‚Üì
Eventos mostrados: 2 m√°quinas da linha de chassis
```

### Exemplo 3: Linha sem Problemas
```
Filtro: "Linha de Montagem Final"
‚Üì
filteredMachines = 5 m√°quinas da linha
‚Üì
problemMachines = 0 m√°quinas (todas NORMAL)
‚Üì
Eventos mostrados: Tabela vazia
```

---

## üìä Detalhes dos Eventos Gerados

### Status da M√°quina ‚Üí Status do Evento

| Status M√°quina | Status Evento | Significado |
|----------------|---------------|-------------|
| FAILURE | IN_PROGRESS | Falha ativa, ainda n√£o resolvida |
| MAINTENANCE | RESOLVED | Manuten√ß√£o conclu√≠da |

### Raz√µes por Status

**FAILURE (Em Progresso):**
- Falha no sensor de proximidade
- Erro de comunica√ß√£o PLC
- Sobrecarga do motor principal
- Falha no sistema hidr√°ulico
- Problema el√©trico detectado

**MAINTENANCE (Resolvido):**
- Manuten√ß√£o preventiva programada
- Substitui√ß√£o de componente
- Lubrifica√ß√£o e ajustes
- Calibra√ß√£o de sensores
- Atualiza√ß√£o de software

### Tempo e Dura√ß√£o

- **startTime:** Entre 2h e 10h atr√°s (escalonado)
- **duration:** Entre 45 e 180 minutos (aleat√≥rio)
- **M√°ximo de eventos:** 5 (para n√£o sobrecarregar a UI)

---

## üîÑ Comportamento Din√¢mico

### Ao Mudar Filtro de Linha

1. **Usu√°rio seleciona linha** ‚Üí `selectedLineId` muda
2. **useEffect detecta mudan√ßa** ‚Üí regenera `filteredMachines`
3. **Componente re-renderiza** ‚Üí `generateDowntimeEvents()` √© executada
4. **Novos eventos gerados** ‚Üí baseados nas m√°quinas da nova linha
5. **Tabela atualizada** ‚Üí mostra apenas eventos relevantes

### Ao Mudar Per√≠odo de An√°lise

Os eventos continuam baseados nas m√°quinas atuais, mas a tabela mostra o estado atual das m√°quinas (n√£o filtrado por data, pois s√£o eventos "recentes").

---

## üìÅ Ficheiro Modificado

```
frontend/src/
‚îî‚îÄ‚îÄ components/Analytics/
    ‚îî‚îÄ‚îÄ AnalyticsDashboard.tsx    ‚úÖ MODIFICADO
```

### Mudan√ßas:
- ‚ùå Removido: Array hardcoded de 3 eventos
- ‚úÖ Adicionado: Fun√ß√£o `generateDowntimeEvents()`
- ‚úÖ Adicionado: Filtro por `filteredMachines`
- ‚úÖ Adicionado: Raz√µes variadas por status
- ‚úÖ Adicionado: Limite de 5 eventos m√°ximo

---

## üöÄ Instala√ß√£o

```bash
# Copiar ficheiro corrigido
cp AnalyticsDashboard.tsx frontend/src/components/Analytics/

# Reiniciar frontend
cd frontend
npm run dev
```

---

## ‚úÖ Testes Recomendados

### Teste 1: Filtro por Linha Espec√≠fica
1. Abrir dashboard de an√°lise
2. Selecionar uma linha espec√≠fica (ex: "Linha de Chassis")
3. **Verificar:** Eventos mostrados s√£o apenas dessa linha
4. **Verificar:** Nome das m√°quinas corresponde √† linha

### Teste 2: Todas as Linhas
1. Selecionar "Todas as Linhas"
2. **Verificar:** Eventos de diferentes linhas aparecem
3. **Verificar:** M√°ximo de 5 eventos

### Teste 3: Linha sem Problemas
1. Selecionar uma linha onde todas as m√°quinas est√£o NORMAL
2. **Verificar:** Tabela vazia ou mensagem apropriada

### Teste 4: Mudan√ßa de Filtro
1. Come√ßar com "Todas as Linhas"
2. Trocar para linha espec√≠fica
3. **Verificar:** Eventos mudam imediatamente
4. Voltar para "Todas as Linhas"
5. **Verificar:** Eventos voltam a mostrar todas as linhas

---

## üé® Experi√™ncia do Utilizador

### Antes ‚ùå
```
Filtro: Linha de Chassis
Eventos Mostrados:
- Rob√¥ de Soldadura 12      (pode n√£o estar nesta linha)
- Prensa Hidr√°ulica 3        (pode n√£o estar nesta linha)
- CNC Fresadora 8            (pode n√£o estar nesta linha)
```

### Depois ‚úÖ
```
Filtro: Linha de Chassis
Eventos Mostrados:
- Prensa de Chassis A1       ‚úÖ (est√° nesta linha)
- Soldadora Chassis B3       ‚úÖ (est√° nesta linha)
- (apenas m√°quinas da linha selecionada)
```

---

## üí° Melhorias Futuras Sugeridas

1. **Filtro por Per√≠odo nos Eventos**
   - Mostrar apenas eventos dentro do dateRange selecionado
   - Requer backend para armazenar hist√≥rico

2. **Hist√≥rico de Eventos**
   - Armazenar eventos passados
   - Permitir an√°lise temporal

3. **Notifica√ß√µes de Novos Eventos**
   - WebSocket para eventos em tempo real
   - Badge de "novo evento"

4. **Detalhes do Evento**
   - Modal com mais informa√ß√µes
   - Timeline de resolu√ß√£o
   - T√©cnico respons√°vel

5. **Export de Eventos**
   - Incluir eventos no relat√≥rio PDF
   - Export CSV de eventos

---

## üéâ Resultado Final

‚úÖ **Eventos de Paragem agora filtrados corretamente por linha de produ√ß√£o!**

- Mostra apenas m√°quinas da linha selecionada
- Eventos din√¢micos baseados no status real
- Raz√µes realistas por tipo de problema
- M√°ximo de 5 eventos para clareza
- Atualiza√ß√£o autom√°tica ao mudar filtro

---

**Vers√£o:** 1.2.3  
**Data:** Janeiro 2025  
**Tipo:** Corre√ß√£o de Filtro + Gera√ß√£o Din√¢mica de Dados